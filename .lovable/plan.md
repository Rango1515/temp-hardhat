

# Partner Program -- Full Implementation Plan

This is a large feature that adds a complete "Partner Program" to the Hardhat Hosting CRM. Partners can refer clients using invite tokens, track their clients and earnings, while admins manage all partners and payouts.

---

## Overview

The system introduces a new `partner` role alongside the existing `admin` and `client` roles. Partners receive special invite tokens from the admin. When a client signs up using a partner token, they are permanently linked to that partner. Partners earn a 5% commission on revenue events generated by their clients, and an optional bonus when a client closes their first case. Admin has full visibility into all partners, clients, payouts, and analytics.

---

## Phase 1: Database Schema (7 new tables + 1 column addition)

### 1.1 Modify `voip_users` table
- Add `partner_id` column (integer, nullable, references voip_users.id) -- links a client to their referring partner

### 1.2 New table: `voip_partner_profiles`
Stores extra partner-specific data (not all partners need to be in a separate table since they use voip_users with role=partner):
- `id` (serial PK)
- `user_id` (integer, unique, references voip_users.id)
- `phone` (text, nullable)
- `payout_method` (text, nullable -- e.g. "PayPal", "Zelle", "Check")
- `payout_details` (text, nullable -- e.g. PayPal email)
- `status` (text, default 'active' -- active/paused)
- `created_at`, `updated_at`

### 1.3 New table: `voip_partner_tokens`
Partner-specific invite tokens (separate from existing `voip_signup_tokens`):
- `id` (serial PK)
- `token_code` (text, unique, not null)
- `partner_id` (integer, not null, references voip_users.id)
- `max_uses` (integer, nullable -- null = unlimited)
- `uses_count` (integer, default 0)
- `expires_at` (timestamptz, nullable)
- `status` (text, default 'active' -- active/revoked)
- `created_by` (integer, references voip_users.id -- admin who created it)
- `created_at`

### 1.4 New table: `voip_partner_token_usage`
Track each use of a partner token:
- `id` (serial PK)
- `token_id` (integer, references voip_partner_tokens.id)
- `client_user_id` (integer, references voip_users.id)
- `created_at`

### 1.5 New table: `voip_revenue_events`
- `id` (serial PK)
- `client_id` (integer, references voip_users.id)
- `partner_id` (integer, references voip_users.id)
- `amount` (numeric, not null)
- `currency` (text, default 'USD')
- `type` (text -- 'subscription', 'setup_fee', 'case_bonus')
- `description` (text, nullable)
- `created_at`

### 1.6 New table: `voip_commissions`
- `id` (serial PK)
- `revenue_event_id` (integer, references voip_revenue_events.id)
- `partner_id` (integer, references voip_users.id)
- `commission_amount` (numeric, not null)
- `commission_rate` (numeric, default 0.05)
- `status` (text, default 'pending' -- pending/approved/paid)
- `notes` (text, nullable)
- `paid_at` (timestamptz, nullable)
- `created_at`

### 1.7 New table: `voip_partner_settings`
Admin-configurable settings:
- `id` (serial PK)
- `commission_rate` (numeric, default 0.05)
- `bonus_type` (text, default 'flat_amount' -- flat_amount/percentage)
- `bonus_value` (numeric, default 0)
- `bonus_enabled` (boolean, default false)
- `apply_bonus_once_per_client` (boolean, default true)
- `updated_by` (integer, nullable)
- `updated_at`

### 1.8 Indexes
- Index on `voip_users.partner_id`
- Index on `voip_partner_tokens.partner_id`
- Index on `voip_partner_tokens.token_code`
- Index on `voip_revenue_events.partner_id`
- Index on `voip_revenue_events.client_id`
- Index on `voip_revenue_events.created_at`
- Index on `voip_commissions.partner_id`
- Index on `voip_commissions.status`

---

## Phase 2: Auth + Role Updates

### 2.1 Update `voip_role` enum
Add `'partner'` to the existing `voip_role` enum type used in `voip_users.role`.

### 2.2 Update `voip-auth` edge function
- In the **signup** action: check if the token is a partner token (from `voip_partner_tokens`). If it is:
  - Set the new user's `partner_id` to the token's `partner_id`
  - Increment the token's `uses_count`
  - Record usage in `voip_partner_token_usage`
  - If `max_uses` reached, auto-revoke
- Fall back to existing `voip_signup_tokens` logic if not a partner token
- Include `partner_id` in JWT payload for partner users

### 2.3 Update `VoipAuthContext.tsx`
- Add `isPartner` boolean (role === 'partner')
- Include `partner_id` in the user object when relevant

### 2.4 Create `PartnerRoute` component
- Similar to `AdminRoute` but checks for `role === 'partner'`
- Partners should also have access to the standard client routes

---

## Phase 3: Edge Functions (Backend API)

### 3.1 New edge function: `voip-partner`
Handles all partner-specific API calls:
- `partner-dashboard` -- aggregate stats for the partner's clients
- `my-clients` -- list clients linked to the requesting partner (paginated)
- `client-detail` -- read-only view of a specific client's activity (only if they belong to this partner)
- `earnings` -- list commissions with filters (status, date range)
- `earnings-summary` -- total lifetime, this month, pending amounts

### 3.2 New edge function: `voip-partner-admin`
Admin-only endpoints:
- `partners` (GET) -- list all partners with stats
- `partners` (POST) -- create a partner (creates voip_user with role=partner + partner profile)
- `partners` (PATCH) -- update partner status/details
- `partner-tokens` (GET) -- list partner tokens with filters
- `partner-tokens` (POST) -- generate a new partner token
- `partner-tokens` (DELETE) -- revoke a token
- `token-usage` (GET) -- usage history for a specific token
- `revenue-events` (GET) -- list all revenue events
- `revenue-events` (POST) -- manually create a revenue event
- `commissions` (GET) -- list commissions with filters
- `commissions` (PATCH) -- approve / mark as paid
- `commissions-export` (GET) -- CSV export
- `partner-settings` (GET/POST) -- get/update commission rate and bonus config

### 3.3 Audit logging
All partner admin actions (create partner, revoke token, approve commission, mark paid) will write to `voip_admin_audit_log`.

---

## Phase 4: Frontend -- Admin Pages

### 4.1 Admin: Partners Page (`/voip/admin/partners`)
- Table of all partners: name, email, status, total clients, total revenue, total commissions, created date
- Click to view/edit partner profile
- "Create Partner" dialog (name, email, password, phone, payout method)
- Status toggle (active/paused)

### 4.2 Admin: Partner Tokens Page (`/voip/admin/partner-tokens`)
- Table of all partner tokens: code (masked), partner name, max uses, uses count, status, expiry, created date
- "Generate Token" dialog: select partner, set max uses (toggle single/multi), set expiration
- Revoke button, usage history modal

### 4.3 Admin: Partner Payouts Page (`/voip/admin/partner-payouts`)
- Revenue events table with filters (partner, date range, type)
- Commissions table with status filters (pending/approved/paid)
- "Approve" and "Mark as Paid" bulk actions
- Export CSV button
- Summary cards: total pending, total approved, total paid (this month / all time)

### 4.4 Admin: Partner Settings
- Commission rate (default 5%)
- Bonus configuration (enabled/disabled, type, value, once per client)
- Added to existing Settings or as a sub-section of Partners page

---

## Phase 5: Frontend -- Partner Pages

### 5.1 Partner Dashboard (`/voip/partner/dashboard`)
- Stat cards: Total Clients, Active Clients, Total Revenue, Total Commission (Lifetime), Commission This Month, Pending Payouts
- Simple chart showing monthly referrals over time
- Quick link to "My Clients" and "Earnings"

### 5.2 My Clients Page (`/voip/partner/clients`)
- Table: client name, company (from lead data), signup date, status, last activity, total calls, cases closed count
- Click to open read-only detail view with basic activity summary

### 5.3 Earnings Page (`/voip/partner/earnings`)
- Commission history table: date, client name, event type, revenue amount, commission amount, status
- Summary cards at top: lifetime earned, this month, pending
- Payout status indicators (pending / approved / paid)

---

## Phase 6: Sidebar + Routing Updates

### 6.1 Sidebar (`VoipSidebar.tsx`)
Add partner nav section (shown when role=partner):
- Partner Dashboard
- My Clients  
- Earnings

Admin sidebar additions:
- Partners
- Partner Tokens
- Partner Payouts

### 6.2 Routes (`App.tsx`)
New routes:
- `/voip/partner/dashboard` -- PartnerRoute
- `/voip/partner/clients` -- PartnerRoute
- `/voip/partner/earnings` -- PartnerRoute
- `/voip/admin/partners` -- AdminRoute
- `/voip/admin/partner-tokens` -- AdminRoute
- `/voip/admin/partner-payouts` -- AdminRoute

### 6.3 Partner users also get access to standard client routes
Partners can also use: Dialer, Call History, Support, Leaderboard, Settings (same as clients)

---

## Phase 7: Commission + Bonus Logic

### 7.1 Revenue Event Creation
When admin creates a revenue event (manual for now):
- Automatically creates a commission record at the configured rate
- Commission = revenue amount x commission rate (default 5%)

### 7.2 Case Close Bonus
When a client's lead status changes to a "closed" outcome and `bonus_enabled` is true:
- Check if bonus has already been applied (if `apply_bonus_once_per_client` is true)
- Create a revenue event of type `case_bonus`
- Create corresponding commission record

### 7.3 Commission Lifecycle
```
pending --> approved (admin action) --> paid (admin marks payout)
```

---

## Phase 8: Security

### 8.1 Server-side enforcement
- All partner endpoints verify JWT role = 'partner' and filter queries by `partner_id`
- Partners can NEVER access data for clients not linked to them
- Admin endpoints verify JWT role = 'admin'

### 8.2 Token security
- Partner tokens shown in full only at creation time (copy to clipboard)
- Displayed masked in lists (first 12 chars + ...)
- Stored as plain text (same pattern as existing signup tokens)

### 8.3 Audit trail
All sensitive actions logged:
- Partner created/disabled
- Token created/revoked
- Partner assigned to client changed
- Commission approved/paid

---

## Technical Details

### Files to Create
1. **Database migration** -- all new tables, enum update, column addition, indexes
2. `supabase/functions/voip-partner/index.ts` -- partner API
3. `supabase/functions/voip-partner-admin/index.ts` -- admin partner management API
4. `src/pages/voip/partner/PartnerDashboard.tsx`
5. `src/pages/voip/partner/PartnerClients.tsx`
6. `src/pages/voip/partner/PartnerEarnings.tsx`
7. `src/pages/voip/admin/Partners.tsx`
8. `src/pages/voip/admin/PartnerTokens.tsx`
9. `src/pages/voip/admin/PartnerPayouts.tsx`
10. `src/components/voip/auth/PartnerRoute.tsx`

### Files to Modify
1. `supabase/config.toml` -- add new edge functions
2. `supabase/functions/voip-auth/index.ts` -- partner token signup flow
3. `src/contexts/VoipAuthContext.tsx` -- add `isPartner`
4. `src/components/voip/layout/VoipSidebar.tsx` -- partner + admin nav items
5. `src/App.tsx` -- new routes
6. `src/pages/voip/Auth.tsx` -- handle `?token=XXXX` URL parameter for partner token links

### Implementation Order
1. Database migration (tables + enum + indexes)
2. Edge functions (voip-partner, voip-partner-admin, auth updates)
3. Auth context + route guards
4. Admin pages (Partners, Tokens, Payouts)
5. Partner pages (Dashboard, Clients, Earnings)
6. Sidebar + routing
7. Signup flow update (token URL parameter)

