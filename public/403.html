<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Access Blocked — HardHat Hosting</title>
  <link rel="icon" type="image/png" href="/hardhat-icon.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      padding: 1.5rem;
    }

    .container {
      max-width: 520px;
      width: 100%;
      text-align: center;
    }

    .code {
      font-size: 5rem;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.05);
      line-height: 1;
      margin-bottom: -0.75rem;
      user-select: none;
    }

    .icon-box {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(239, 68, 68, 0.1);
      border: 2px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .icon-box svg { width: 40px; height: 40px; }

    .rule-badge {
      display: inline-flex;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      margin-bottom: 1rem;
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
    }

    h1 { font-size: 1.5rem; font-weight: 700; color: #f5f5f5; margin-bottom: 0.5rem; }

    .description { color: #a3a3a3; line-height: 1.6; margin-bottom: 1.5rem; font-size: 0.95rem; }

    .details-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      text-align: left;
    }

    .details-card h3 {
      font-size: 0.8rem; font-weight: 600; color: #d4d4d4;
      margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
    }

    .detail-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.35rem 0; font-size: 0.85rem;
    }

    .detail-row + .detail-row { border-top: 1px solid rgba(255, 255, 255, 0.05); }
    .detail-label { color: #737373; }
    .detail-value {
      color: #d4d4d4; font-weight: 500;
      font-family: 'SF Mono', SFMono-Regular, Consolas, monospace; font-size: 0.8rem;
    }

    .info-box {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px; padding: 0.875rem 1.25rem; margin-bottom: 1.5rem;
    }

    .info-box p { font-size: 0.85rem; color: #a3a3a3; line-height: 1.5; }

    .timer-ring-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .timer-ring-container {
      position: relative;
      width: 100px;
      height: 100px;
    }

    .timer-ring-container svg {
      transform: rotate(-90deg);
      width: 100px;
      height: 100px;
    }

    .timer-ring-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.06);
      stroke-width: 5;
    }

    .timer-ring-progress {
      fill: none;
      stroke: #ef4444;
      stroke-width: 5;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear;
    }

    .timer-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.75rem;
      font-weight: 700;
      color: #ef4444;
      font-variant-numeric: tabular-nums;
    }

    .timer-number span {
      font-size: 0.7rem;
      font-weight: 400;
      color: #737373;
      display: block;
      margin-top: -2px;
    }

    .timer-label {
      font-size: 0.85rem;
      color: #737373;
    }

    .status-msg { font-size: 0.8rem; min-height: 1.2em; text-align: center; margin-bottom: 1rem; }
    .status-msg.error { color: #ef4444; }
    .status-msg.success { color: #22c55e; }

    .footer { margin-top: 2rem; font-size: 0.75rem; color: rgba(255, 255, 255, 0.2); }
    .footer a { color: #f97316; text-decoration: none; }
    .footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container" id="root">
    <p style="color:#737373;">Loading…</p>
  </div>

  <script>
    var BLOCK_KEY = 'waf_block_until';
    var BLOCK_RULE_KEY = 'waf_block_rule';
    var BLOCK_DURATION_KEY = 'waf_block_duration_min';
    var SUPABASE_URL = 'https://sqtbqtpudoossunaaofx.supabase.co';
    var CHECK_URL = SUPABASE_URL + '/functions/v1/voip-security?action=check-block';

    function clearBlockStorage() {
      localStorage.removeItem(BLOCK_KEY);
      localStorage.removeItem(BLOCK_RULE_KEY);
      localStorage.removeItem(BLOCK_DURATION_KEY);
      localStorage.removeItem('waf_retry_count');
      localStorage.removeItem('waf_retry_window_start');
    }

    function goHome() {
      clearBlockStorage();
      window.location.replace('/');
    }

    function checkServer() {
      return fetch(CHECK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        return { blocked: d.blocked === true, seconds: d.remaining_seconds || 0 };
      })
      .catch(function() {
        return { blocked: true, seconds: 30 };
      });
    }

    // Lock navigation for server-level 403s
    history.pushState(null, '', location.href);
    window.addEventListener('popstate', function() {
      history.pushState(null, '', location.href);
    });

    checkServer().then(function(result) {
      if (!result.blocked) {
        goHome();
        return;
      }

      var seconds = Math.max(5, result.seconds);
      localStorage.setItem(BLOCK_KEY, String(Date.now() + seconds * 1000));

      var durationMin = Math.max(1, Math.ceil(seconds / 60));
      var circumference = 2 * Math.PI * 42;

      var root = document.getElementById('root');
      root.innerHTML =
        '<div class="code">403</div>' +
        '<div class="icon-box">' +
          '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' +
            '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>' +
            '<line x1="4" y1="4" x2="20" y2="20"/>' +
          '</svg>' +
        '</div>' +
        '<div class="rule-badge">BLOCKED</div>' +
        '<h1>Access Temporarily Blocked</h1>' +
        '<p class="description">Your IP address has been temporarily blocked due to suspicious activity. This is an automated security measure.</p>' +
        '<div class="details-card">' +
          '<h3>Block Details</h3>' +
          '<div class="detail-row"><span class="detail-label">Block Duration</span><span class="detail-value">' + durationMin + ' min</span></div>' +
          '<div class="detail-row"><span class="detail-label">Your IP</span><span class="detail-value" id="user-ip">detecting…</span></div>' +
        '</div>' +
        '<div class="info-box"><p><strong>Why was I blocked?</strong> Our Web Application Firewall detected activity from your IP that violates our security policies.</p></div>' +
        '<div class="timer-ring-wrap">' +
          '<div class="timer-ring-container">' +
            '<svg viewBox="0 0 100 100">' +
              '<circle class="timer-ring-bg" cx="50" cy="50" r="42"/>' +
              '<circle class="timer-ring-progress" id="ringProgress" cx="50" cy="50" r="42" ' +
                'stroke-dasharray="' + circumference + '" stroke-dashoffset="0"/>' +
            '</svg>' +
            '<div class="timer-number"><span id="timerNum">' + seconds + '</span><span>seconds</span></div>' +
          '</div>' +
          '<div class="timer-label">You\'ll be redirected automatically</div>' +
        '</div>' +
        '<p class="status-msg" id="statusMsg"></p>' +
        '<div class="footer"><p>If you believe this is an error, contact <a href="mailto:admin@hardhathosting.work">admin@hardhathosting.work</a></p></div>';

      // Cosmetic IP
      fetch('https://api.ipify.org?format=json')
        .then(function(r) { return r.json(); })
        .then(function(d) { var el = document.getElementById('user-ip'); if (el) el.textContent = d.ip || 'unknown'; })
        .catch(function() { var el = document.getElementById('user-ip'); if (el) el.textContent = 'hidden'; });

      // Countdown
      var elapsed = 0;
      var interval = setInterval(function() {
        elapsed++;
        var left = Math.max(0, seconds - elapsed);
        document.getElementById('timerNum').textContent = left;
        document.getElementById('ringProgress').setAttribute('stroke-dashoffset', String(circumference * (elapsed / seconds)));

        if (left <= 0) {
          clearInterval(interval);
          document.getElementById('statusMsg').textContent = 'Checking with server…';
          checkServer().then(function(r) {
            if (!r.blocked) {
              document.getElementById('statusMsg').textContent = 'Block lifted! Redirecting…';
              document.getElementById('statusMsg').className = 'status-msg success';
              setTimeout(goHome, 500);
            } else {
              var ns = Math.max(10, r.seconds);
              localStorage.setItem(BLOCK_KEY, String(Date.now() + ns * 1000));
              document.getElementById('statusMsg').textContent = 'Still blocked. Waiting ' + ns + 's more…';
              document.getElementById('statusMsg').className = 'status-msg error';
              setTimeout(function() {
                document.getElementById('statusMsg').textContent = '';
                seconds = ns;
                elapsed = 0;
                document.getElementById('timerNum').textContent = ns;
                document.getElementById('ringProgress').setAttribute('stroke-dashoffset', '0');
                interval = setInterval(arguments.callee, 1000);
              }, 2000);
            }
          });
        }
      }, 1000);
    });
  </script>
</body>
</html>