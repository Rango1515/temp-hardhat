<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Access Blocked — HardHat Hosting</title>
  <link rel="icon" type="image/png" href="/hardhat-icon.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      padding: 1.5rem;
    }

    .container {
      max-width: 520px;
      width: 100%;
      text-align: center;
    }

    .code {
      font-size: 5rem;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.05);
      line-height: 1;
      margin-bottom: -0.75rem;
      user-select: none;
    }

    .icon-box {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-box svg {
      width: 40px;
      height: 40px;
    }

    /* Rule-specific color themes */
    .theme-rate-flood .icon-box      { background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); color: #ef4444; }
    .theme-sustained-flood .icon-box { background: rgba(220, 38, 38, 0.12); border: 2px solid rgba(220, 38, 38, 0.35); color: #dc2626; }
    .theme-brute-force .icon-box     { background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); color: #f59e0b; }
    .theme-endpoint-abuse .icon-box  { background: rgba(168, 85, 247, 0.1); border: 2px solid rgba(168, 85, 247, 0.3); color: #a855f7; }
    .theme-connection-flood .icon-box { background: rgba(249, 115, 22, 0.1); border: 2px solid rgba(249, 115, 22, 0.3); color: #f97316; }
    .theme-default .icon-box         { background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); color: #ef4444; }

    .rule-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      margin-bottom: 1rem;
    }

    .theme-rate-flood .rule-badge      { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
    .theme-sustained-flood .rule-badge { background: rgba(220, 38, 38, 0.15); color: #fca5a5; }
    .theme-brute-force .rule-badge     { background: rgba(245, 158, 11, 0.15); color: #fcd34d; }
    .theme-endpoint-abuse .rule-badge  { background: rgba(168, 85, 247, 0.15); color: #d8b4fe; }
    .theme-connection-flood .rule-badge { background: rgba(249, 115, 22, 0.15); color: #fdba74; }
    .theme-default .rule-badge         { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }

    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #f5f5f5;
      margin-bottom: 0.5rem;
    }

    .description {
      color: #a3a3a3;
      line-height: 1.6;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    .details-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      text-align: left;
    }

    .details-card h3 {
      font-size: 0.8rem;
      font-weight: 600;
      color: #d4d4d4;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.35rem 0;
      font-size: 0.85rem;
    }

    .detail-row + .detail-row {
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .detail-label {
      color: #737373;
    }

    .detail-value {
      color: #d4d4d4;
      font-weight: 500;
      font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
      font-size: 0.8rem;
    }

    .info-box {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 0.875rem 1.25rem;
      margin-bottom: 1.5rem;
    }

    .info-box p {
      font-size: 0.85rem;
      color: #a3a3a3;
      line-height: 1.5;
    }

    .countdown {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #737373;
      margin-bottom: 1.5rem;
    }

    .countdown svg {
      width: 16px;
      height: 16px;
    }

    .countdown #timer {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .theme-rate-flood .countdown #timer      { color: #ef4444; }
    .theme-sustained-flood .countdown #timer { color: #dc2626; }
    .theme-brute-force .countdown #timer     { color: #f59e0b; }
    .theme-endpoint-abuse .countdown #timer  { color: #a855f7; }
    .theme-connection-flood .countdown #timer { color: #f97316; }
    .theme-default .countdown #timer         { color: #f97316; }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      font-family: inherit;
    }

    .btn-primary {
      background: #f97316;
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      background: #ea580c;
    }

    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    .footer {
      margin-top: 2rem;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.2);
    }

    .footer a {
      color: #f97316;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    @media (min-width: 640px) {
      .actions {
        flex-direction: row;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="root">
    <!-- Content injected by JS based on rule query param -->
  </div>

  <script>
    // ── Rule definitions ──────────────────────────────────────────────────
    const RULES = {
      "rate_flood": {
        theme: "rate-flood",
        badge: "RATE FLOOD",
        title: "Rate Flood Detected",
        description: "You triggered our rate flood protection by sending too many requests in a short burst. This is typically caused by rapid page refreshing or automated scripts.",
        icon: "flood",
        why: "Your IP exceeded the maximum allowed requests within a 10-second window. This limit exists to prevent denial-of-service attacks.",
        threshold: "> 60 requests / 10 seconds",
        blockDuration: "1 minute",
        retrySeconds: 60,
      },
      "sustained_flood": {
        theme: "sustained-flood",
        badge: "SUSTAINED FLOOD",
        title: "Sustained Flood Detected",
        description: "Our system detected a sustained high volume of requests from your IP address over an extended period, consistent with a flood attack pattern.",
        icon: "waves",
        why: "Your IP maintained an abnormally high request rate over 60 seconds. This protection prevents resource exhaustion attacks.",
        threshold: "> 300 requests / 60 seconds",
        blockDuration: "60 minutes",
        retrySeconds: 300,
      },
      "brute_force": {
        theme: "brute-force",
        badge: "BRUTE FORCE",
        title: "Brute Force Attempt Blocked",
        description: "Too many failed login attempts were detected from your IP address. This protection prevents unauthorized access to accounts.",
        icon: "lock",
        why: "Multiple consecutive failed login attempts suggest a password-guessing attack. Your IP has been temporarily locked out of authentication endpoints.",
        threshold: "> 15 failed logins / 2 minutes",
        blockDuration: "15 minutes",
        retrySeconds: 180,
      },
      "endpoint_abuse": {
        theme: "endpoint-abuse",
        badge: "ENDPOINT ABUSE",
        title: "Sensitive Endpoint Abuse",
        description: "Excessive requests to protected system endpoints were detected from your IP. Access to administrative and data routes has been temporarily restricted.",
        icon: "shield",
        why: "Your IP sent an unusually high number of requests to sensitive routes (admin panels, lead data, authentication). This is blocked to prevent data scraping and enumeration attacks.",
        threshold: "> 30 requests / 30 seconds on sensitive routes",
        blockDuration: "15 minutes",
        retrySeconds: 180,
      },
      "connection_flood": {
        theme: "connection-flood",
        badge: "CONNECTION FLOOD",
        title: "Connection Flood Detected",
        description: "An extreme burst of connections was detected from your IP address within seconds. This pattern is consistent with automated attack tools.",
        icon: "zap",
        why: "Your IP opened more than 20 connections in under 5 seconds. This micro-burst pattern indicates automated flooding rather than normal browsing.",
        threshold: "> 20 requests / 5 seconds",
        blockDuration: "5 minutes",
        retrySeconds: 120,
      },
      "automated_tool": {
        theme: "connection-flood",
        badge: "BOT DETECTED",
        title: "Automated Tool Blocked",
        description: "Our TLS fingerprinting system identified your traffic as originating from an automated tool rather than a standard web browser.",
        icon: "bot",
        why: "The combination of your IP address and request pattern matches known automated tool signatures. Only legitimate browser traffic is permitted.",
        threshold: "> 15 requests / 5 seconds (same fingerprint)",
        blockDuration: "Varies (progressive)",
        retrySeconds: 120,
      },
    };

    const DEFAULT_RULE = {
      theme: "default",
      badge: "BLOCKED",
      title: "Access Temporarily Blocked",
      description: "Your IP address has been temporarily blocked due to suspicious activity. This is an automated security measure.",
      icon: "shield",
      why: "Our Web Application Firewall detected activity from your IP that violates our security policies.",
      threshold: "N/A",
      blockDuration: "Varies",
      retrySeconds: 60,
    };

    // ── Icons ─────────────────────────────────────────────────────────────
    const ICONS = {
      flood: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/></svg>',
      waves: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/></svg>',
      lock: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/><line x1="12" y1="16" x2="12" y2="19"/></svg>',
      shield: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="4" y1="4" x2="20" y2="20"/></svg>',
      zap: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
      bot: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>',
    };

    // ── Parse query params ────────────────────────────────────────────────
    const params = new URLSearchParams(window.location.search);
    const ruleKey = (params.get("rule") || "").toLowerCase().replace(/\s+/g, "_").replace(/[^a-z_]/g, "");
    const durationParam = params.get("duration");

    const rule = RULES[ruleKey] || DEFAULT_RULE;
    if (durationParam) {
      rule.blockDuration = durationParam + " minutes";
    }

    document.title = rule.title + " — HardHat Hosting";

    // ── Render ─────────────────────────────────────────────────────────────
    document.getElementById("root").className = "container theme-" + rule.theme;
    document.getElementById("root").innerHTML = `
      <div class="code">403</div>

      <div class="icon-box">
        ${ICONS[rule.icon] || ICONS.shield}
      </div>

      <div class="rule-badge">${rule.badge}</div>

      <h1>${rule.title}</h1>
      <p class="description">${rule.description}</p>

      <div class="details-card">
        <h3>Block Details</h3>
        <div class="detail-row">
          <span class="detail-label">Rule Triggered</span>
          <span class="detail-value">${rule.badge}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Threshold</span>
          <span class="detail-value">${rule.threshold}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Block Duration</span>
          <span class="detail-value">${rule.blockDuration}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Your IP</span>
          <span class="detail-value" id="user-ip">detecting…</span>
        </div>
      </div>

      <div class="info-box">
        <p><strong>Why was I blocked?</strong> ${rule.why}</p>
      </div>

      <div class="countdown">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span>Auto-retry in <span id="timer">${rule.retrySeconds}</span>s</span>
      </div>

      <div class="actions">
        <button class="btn btn-primary btn-disabled" id="retryBtn" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px">
            <polyline points="23 4 23 10 17 10"/>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
          </svg>
          Wait <span id="retryTimer">${rule.retrySeconds}</span>s
        </button>
      </div>

      <div class="footer">
        <p>If you believe this is an error, contact <a href="mailto:admin@hardhathosting.work">admin@hardhathosting.work</a></p>
      </div>
    `;

    // ── Lock navigation (prevent back/forward) ──────────────────────────
    history.pushState(null, '', location.href);
    window.addEventListener('popstate', function () {
      history.pushState(null, '', location.href);
    });

    // Supabase URL for block status checks
    var SUPABASE_URL = 'https://sqtbqtpudoossunaaofx.supabase.co';

    // Check if IP is still blocked by calling the public endpoint
    async function checkIfStillBlocked() {
      try {
        var res = await fetch(SUPABASE_URL + '/functions/v1/voip-security?action=check-block', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        var data = await res.json();
        return data.blocked === true;
      } catch(e) {
        return true; // Assume blocked if can't reach server
      }
    }

    // On page load, verify the block is real
    (async function() {
      var stillBlocked = await checkIfStillBlocked();
      if (!stillBlocked) {
        window.location.href = '/';
        return;
      }
    })();

    // Status message element (add dynamically)
    var statusDiv = document.createElement('p');
    statusDiv.style.cssText = 'font-size:0.8rem;color:#ef4444;margin-top:0.75rem;min-height:1.2em;text-align:center;';
    statusDiv.id = 'statusMsg';
    document.querySelector('.actions').after(statusDiv);

    // ── Countdown timer ───────────────────────────────────────────────────
    let seconds = rule.retrySeconds;
    const timerEl = document.getElementById("timer");
    const retryTimerEl = document.getElementById("retryTimer");
    const retryBtn = document.getElementById("retryBtn");

    setInterval(() => {
      seconds--;
      if (seconds <= 0) {
        retryBtn.disabled = false;
        retryBtn.classList.remove('btn-disabled');
        retryBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Try Again';
        retryBtn.onclick = async function() {
          retryBtn.disabled = true;
          retryBtn.classList.add('btn-disabled');
          retryBtn.innerHTML = 'Checking...';
          statusDiv.textContent = '';

          var stillBlocked = await checkIfStillBlocked();
          if (stillBlocked) {
            statusDiv.textContent = 'Your IP is still blocked. Please wait longer.';
            retryBtn.disabled = false;
            retryBtn.classList.remove('btn-disabled');
            retryBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Try Again';
          } else {
            window.location.href = '/';
          }
        };
        return;
      }
      timerEl.textContent = seconds;
      retryTimerEl.textContent = seconds;
    }, 1000);

    // Periodically check if block has expired (every 15s)
    setInterval(async function() {
      var stillBlocked = await checkIfStillBlocked();
      if (!stillBlocked) {
        window.location.href = '/';
      }
    }, 15000);

    // ── Try to detect user's IP (optional, cosmetic) ──────────────────────
    fetch("https://api.ipify.org?format=json")
      .then(r => r.json())
      .then(d => { document.getElementById("user-ip").textContent = d.ip || "unknown"; })
      .catch(() => { document.getElementById("user-ip").textContent = "hidden"; });
  </script>
</body>
</html>
